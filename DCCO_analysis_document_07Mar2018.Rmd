---
title: "Double-Crested Cormorant Populations in San Francisco Bay from 1985--2017"
subtitle: "Draft of Analyses"
author: "Max Tarjan"
date: "`r Sys.Date()`"
output:
  word_document:
    reference_docx: DCCO_format_doc.docx
    pandoc_args: ["--smart"]
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, echo=FALSE, warning=FALSE, include=FALSE}
source('DCCO_pop_analysis_code_5Feb2018.R')
figure.num<-0
table.num<-0
```


# Background
This manuscript describes trends in DCCO populations in the San Francisco Bay Area from 1985--2017.

#Methods
##General Additive Mixed Models (GAMMs)
Count data are frequently used to estimate population trends, but are subject to biases in data collection. Notably, raw counts are strongly affected by survey effort and survey dates. Our raw counts are likey subject to these effects. The North Bay and South Bay regions contain multiple (12+) DCCO nesting colonies, but not all sites were visited in each year. Site occupation also depends on day of the season. Birds arrive to breed in April, peak breeding occurs in June, and they depart in August. Nest counts increase and then decrease as the season progresses, so day of the season is an important covariate when inferring colony size. Other potential covariates are survey type (aerial, boat, or ground). To account for potential biases, we tested competing models that included measured covariates in our estimates of regional trends. Long-term population dynamics are frequently non-linear, so we used an approach that would allow for nonlinear trends.

General additive mixed models allow each colony to growth nonlinearly over time by including an interaction term between colony and year. Estimating the regional counts by summing colony counts and weighting those counts by estimated error corrects for years when certain colonies were not visited. This method also allows for additive terms to inform colony size, so I was able to test the effect of count date and survey type on colony counts.

Methods follow those of Shadish et al. 2014. GAMMs were devoped using the gam function in R. I considered the following models:

Model 0) count ~ s(year * colony) + colony

Model 1) count ~ s(year * colony) + colony + s(day)

Model 2) count ~ s(year * colony) + colony + survey type

Model 3) count ~ s(year * colony) + colony + s(day) + survey type

where the s() function allows the estimate to vary nonlinearly, and the year by colony interaction allows the colony trend to change nonlinearly across years. I assessed the model fit using the un-biased risk estimator (UBRE), which is the minimised generalised cross-validation score of the fitted GAM. Lower UBRE scores indicate a better model fit to the data (Wood 2006). I also compared the models using AIC.

I calcuated each annual regional trend estimate (mean and standard deviation) by simulating a distribution of regional estimates across a range of colony trend estimates. I randomly selected 10,000 replicate estimates for each colony*year parameter from a normal distribution of estimates, where the mean was equal to the mean reported by the model and the standard deviation (sd) was equal to the standard error (se) reported by the model multiplied by the square root of the estimated degrees of freedom (edf) plus one, such that:

sd = se * sqrt(edf+1)

I then calculated the annual regional trend estimate for each of these replicates. I assumed that the regional trend estimate in a given year is equal to the sum of the estimated colony trends. The estimated colony trends were weighted by relative colony size (mean colony size divided by the sum of mean colony sizes in the region) and the relative error of the estimate (standard error of the estimate at a given colony divided by the sum of the standard errors for all colonies in the region).

The regional estimate for each year is thus represented by the mean and standard deviation of these 10,000 replicate regional estimates, and encompasses the error in each of the colony trend estimates.

#Results
##Model selection
Model 2 (count as a function of year, colony, and survey type) had the lowest AIC score of the four models tested. The models that included the day of season effect had high AIC scores because the effect requires that the model fit a substantially larger number of parameters. However, the full mode suggested that the day of season effect was significant (p<0.0001) and the parameter estimates indicated that counts collected early in the season are strongly biased. To avoid this bias, we selected the full model to estimate regional trends. The full GAMM had a UBRE score of `r round(summary(model.plot)$sp.criterion,2)` and the deviance explained was `r round(summary(model.plot)$dev.expl*100,0)`%. 

##Effects of covariates
The parameter estimates for Aerial surveys differ significantly from Boat/Ground, Boat, and Ground surveys (p<0.001). Survey date showed a non-linear trend, where surveys early in the season and at the very end of the season resulted in lower trend estimates.

##Regional trends
###Bridges Region
Since 1992, DCCO colonies in the Bridges Region showed an overall increasing trend through 1999. Trend estimates remained high until a sharp decline, which began in 2003 and took off in 2004 until a regional low in 2010. The regional trend then increased until 2014 and fell again through 2017.

###North Bay
The North Bay region DCCO populations show an increase in trend from 1989 until 2008, and then decrease until 2017. The North Bay region has more colonies than other regions considered and shows significant variability in trend estimates across colonies, with some growing and some declining in the same years. This led to large error estimates in the regional trend.

###Outer Coast
DCCO colonies of the Outer Coast region show an increasing trend from the first count in 1997 to 2006, at which point the trend plateaus with only a slight increase from 2008 to 2013.

###South Bay
DCCO colonies in the South Bay region increased from the first count in 1988 to 2006, following which there was a slight dip in the trend in 2009/2010, and little notable increase through 2017.

###South Farallon Islands
The South Farallon Islands region, which is composed of only one colony, showed growth from 1987 to 2004, with faster rates from 1987-1991 and 1997-2003. The regional trend then decreased across the entire period from 2004-2017, with the lowest count of the study period recorded in 2015.

#Works Cited

Knape, J. (2016). Decomposing trends in Swedish bird populations using generalized additive mixed models. Journal of Applied Ecology, 53(6), 1852–1861. https://doi.org/10.1111/1365-2664.12720

Shadish, W. R., Zuur, A. F., & Sullivan, K. J. (2014). Using generalized additive (mixed) models to analyze single case designs. Journal of School Psychology, 52(2), 149–178. https://doi.org/10.1016/j.jsp.2013.11.004

Wood, S. N. (2006). Generalized Additive Models: An Introduction with R. Chapman and Hall/CRC.

#Tables
```{r, echo=FALSE}
table.num<-table.num+1
```
Table `r table.num`. Site descriptions, including region, coordinates, and number of years with nest counts.
```{r, echo=FALSE}
knitr::kable(ms.table1)
```


```{r, echo=FALSE}
table.num<-table.num+1
```
Table `r table.num`. Model fit and deviance explained for the four GAMMs tested.
```{r, echo=FALSE}
knitr::kable(model.fit)
```

```{r, echo=FALSE}
table.num<-table.num+1
```
Table `r table.num`. Percent change in each region across pre- bridge construction (start-2003), post- bridge construction (2003-2017), and all (start-2017) years.
```{r, echo=FALSE}
knitr::kable(change.dat)
```

#Figures
```{r, echo=FALSE}
knitr::include_graphics(path="C:/Users/max/Desktop/Tarjan/Science/GIS/DCCO_GIS/DCCO_sites_map_11Mar2018.png")

figure.num<-figure.num+1
```
Fig `r figure.num`. Map of DCCO nesting sites from 1985-2017 in the San Francisco Bay Area.


```{r, echo=FALSE}
knitr::include_graphics(path="fig.Bridges.counts.colonies.png")
figure.num<-figure.num+1
```
Fig `r figure.num`. Colony counts for Bridges region.

######Page break
```{r, echo=FALSE}
knitr::include_graphics(path="fig.North Bay.counts.colonies.png")
figure.num<-figure.num+1
```
Fig `r figure.num`. Colony counts for North Bay region.

######Page break
```{r, echo=FALSE}
knitr::include_graphics(path="fig.Outer Coast.counts.colonies.png")
figure.num<-figure.num+1
```
Fig `r figure.num`. Colony counts for Outer Coast region.

######Page break
```{r, echo=FALSE}
knitr::include_graphics(path="fig.South Bay.counts.colonies.png")
figure.num<-figure.num+1
```
Fig `r figure.num`. Colony counts for South Bay region. 

######Page break
```{r, echo=FALSE}
knitr::include_graphics(path="fig.South Farallon Islands.counts.colonies.png")
figure.num<-figure.num+1
```
Fig `r figure.num`. Colony counts for South Farallon Islands region.

######Page break
```{r, echo=FALSE}
knitr::include_graphics(path="fig.regional.trends.facet.png")
figure.num<-figure.num+1
```
Fig `r figure.num`. Standardized GAM trends for each region in SF Bay.

######Page break
```{r, echo=FALSE}
knitr::include_graphics(path="fig.SF.trend.png")
figure.num<-figure.num+1
```
Fig `r figure.num`. GAM trend for all SF Bay colonies.

######Page break
```{r, echo=FALSE}
knitr::include_graphics(path="fig.day.effect.png")
figure.num<-figure.num+1
```
Fig `r figure.num`. Effect of count date (ie day of the year) illustrated using predicted trend values for a standardized site, year, and survey type. 

######Page break
```{r, echo=FALSE}
knitr::include_graphics(path="fig.type.effect.png")
figure.num<-figure.num+1
```
Fig `r figure.num`. Effect of survey type illustreated using the predicted trend value for a standard site, year, and day with standard error bars. This plot illustrates that survey types result in counts that differ in their similarity to the latent colony size. Counts from Aerial surveys differ significantly from Boat/Ground, Boat, and Ground surveys.  Aerial surveys that report a given colony count result in trend estimates that are `r round((subset(counts.type, Survey.type=="Aerial")$pred-subset(counts.type, Survey.type=="Ground")$pred)/(subset(counts.type, Survey.type=="Aerial")$pred+subset(counts.type, Survey.type=="Ground")$pred)*100, 2)`% larger than a Ground survey reporting the same colony count. 

